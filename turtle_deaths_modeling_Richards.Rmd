---
title: "Turtle deaths modeling"
output: html_notebook
---

I try to model turtle deaths at Raine Island by using a parametric function to determine missing counts.  They are only a few observations each season but the beginning (October 15) and end (April 30) of each season are assumed known. There is a peak during each season. I use modified Richards' function, which was used to model phenology of turtle nesting in Girondot et al. (2007). I extended the modification by Girondot et al. (2007) by creating asymmetrical curves. 

The function in Girondot et al. (2007) has the following form:
S1 <- -S
M1 <- (1 + (2 * exp(K) - 1) * exp((1/S1) * (P - d))) ^ (-1/exp(K))
M2 <- (1 + (2 * exp(K) - 1) * exp((1/S) * (P - d))) ^ (-1/exp(K))
N <- min + (max - min) * (M1 * M2)

d = the number of days from the beginning of nesting season
S > 0 and S1 = -S define the "fatness" of the function
K > 0 defines the "flatness" at the peak of the function
P defines where the peak is relative to the range of d min(d) < P < max(d).
For this analysis, I set P to the middle of the season, that is 
P = floor((max(d) - min(d))/2) because there is not enough data to estimate this parameter.
min = 0.

Observed counts of deaths are assumed to be normally distributed around this function.

I created six variants of this function by making different assumptions about S and K parameters.
Model 1: S and K are constants (S_K)
Model 2: S is season dependent, whereas K is constant (St_K)
Model 3: S is constant and K for M1 and M2 are different but season independent (S_K1_K2)
Model 4: S is season dependent and K for M1 and M2 are different but season independent (St_K1_K2)
Model 5: absolute values of S and S1 are not the same (creates a non-symmetrical function), whereas K is constant (S1_S2_K)
Model 6: absolute values of S and S1 are not the same and K for M1 and M2 are different but season independent (S1_S2_K1_K2)

Varying K by season resulted in non-convergence. Consequently, time dependent K models were not considered. 

Girondot et al. (2007): Modeling approaches to quantify leatherback nesting trends in French Guiana and Suriname. Chelonian Conservation and Biology 6(1): 37-46.

```{r}
rm(list=ls())

library(tidyverse)
library(ggplot2)
library(lubridate)
library(readr)
library(reshape2)
library(jagsUI)
library(bayesplot)
library(loo)

source("Dunstan_functions.R")
```

Get the data. Then, create a dataframe and create Season and Day of Season (DOS) variables.  

```{r}
col.def <- cols(Date = col_date(format = "%m/%d/%Y"),
                Heat = col_integer(),
                Cliff = col_integer(),
                Total = col_integer())

# Begin and end dates for each season
Day.begin <- "10-15"
Day.end <- "04-30"
# define nesting seasons - not the same as calendar years
# also define day of season, starts on 10-15

data.1 <- read_csv(file = "data/Turtle_deaths_with_zeros.csv",
                   col_types = col.def) %>%
  mutate(Year = year(Date),
         DOY = yday(Date),
         Season = ifelse(Date >= paste0(Year, "-", Day.end), 
                         Year, Year-1),
         Season.f = as.factor(Season), 
         DOS = as.numeric(Date - as.Date(paste0(Season, "-", Day.begin)))) %>%  
  group_by(Season.f) %>%
  mutate(Cum_Heat = cumsum(Heat),
         Cum_Cliff = cumsum(Cliff))

# find the number of days between Day1 and Day2
n.days <- as.numeric(as.Date(paste0("2018-", Day.end)) - as.Date(paste0("2017-", Day.begin)))

seasons <- unique(data.1$Season)

data.0 <- data.frame(Season = rep(seasons, each = n.days),
                     DOS = rep(seq(from = 1, to = n.days, by = 1), 
                                    times = length(seasons))) %>% 
  mutate(Date = as.Date(paste0(Season, "-", Day.begin)) + days(DOS))

data.0 %>% left_join(data.1, by = "Date") -> data.0.1

obs.y <- array(NA, c(length(seasons), 2, n.days))

for (i in 1:length(seasons)){
  obs.y[i, ,] <- t(filter(data.0.1, Season.x == seasons[i]) %>% 
                     select(c("Heat", "Cliff")))
  
}

n.seasons <- length(unique(data.1$Season))
max.days <- data.1 %>% 
  group_by(Season.f) %>% 
  summarise(total.days = max(DOS),
            n.days = n()) 

obs.y.1 <- array(data = NA, dim = c(n.seasons, max(max.days$n.days), 2))
obs.t <- matrix(NA, nrow = n.seasons, ncol = max(max.days$n.days))
n.vec <- P <- vector(mode = "numeric", length = n.seasons)
#season.sector.idx <- matrix(NA, nrow = length(Sectors) * length(seasons), ncol = 2)
#max.vec <- vector(mode = "numeric", length = length(seasons))
max.mat <- matrix(NA, nrow = length(seasons), ncol = 2)

season_idx <- cause_idx <- 1
for (season_idx in 1:n.seasons){
  data.1 %>% filter(Season == seasons[season_idx]) -> tmp
  n.vec[season_idx] <- nrow(tmp)
  P[season_idx] <- floor(max(tmp$DOS)/2)
  
  for (cause_idx in 1:2){
    
    if (nrow(tmp) > 0){
      obs.t[season_idx, 1:nrow(tmp)] <- tmp$DOS
      tmp2 <- ifelse(cause_idx == 1,
                     tmp[, "Heat"],
                     tmp[, "Cliff"])
      
      obs.y.1[season_idx, 1:nrow(tmp), cause_idx] <- unlist(tmp2)
      
      max.mat[season_idx, cause_idx] <- ifelse(cause_idx == 1,
                                               max(tmp$Heat, na.rm = T),
                                               max(tmp$Cliff, na.rm = T))
    }
    
  }
}


```

Because no obvious correlation between heat-related and cliff fall deaths, I fit the functions to each cause of death separately. 

Set MCMC parameters

```{r}
MCMC.params <- list(n.chains = 4,
                    n.samples = 50000,
                    n.burnin = 10000,
                    n.thin = 5)

n.per.chain <- (MCMC.params$n.samples - MCMC.params$n.burnin)/MCMC.params$n.thin

```


# Heat related deaths

```{r}

jags.data.Heat <- list(y = (obs.y.1[,,1]),
                       t = obs.t,
                       P = P,
                       n.vec = n.vec,
                       n.seasons = n.seasons,
                       max.vec = max.mat[,1])

# Convert the data into a vector also and match with the log-likelihood vector
# for computing looic.
data.heat.vector <- as.vector(jags.data.Heat$y) %>% 
  rep(each = MCMC.params$n.chains * n.per.chain)

jags.params <- c("sigma.y", "S", "K", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Heat_S_K_norm.rds"))){
  M1.Heat <- jags(jags.data.Heat,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Richards_S_K_norm.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  saveRDS(M1.Heat, paste0("RData/Richards_Heat_S_K_norm.rds"))
  
} else {
  M1.Heat <- readRDS(paste0("RData/Richards_Heat_S_K_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_S_K_norm_LOOIC.rds")){
  M1.Heat.loo.out <- compute.looic(loglik = M1.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M1.Heat.loo.out, "RData/Richards_Heat_S_K_norm_LOOIC.rds")
} else {
  M1.Heat.loo.out <- readRDS("RData/Richards_Heat_S_K_norm_LOOIC.rds")
}

if (!file.exists(paste0("RData/Richards_Heat_St_K_norm.rds"))){ 
  M2.Heat <- jags(jags.data.Heat,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_St_K_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M2.Heat, paste0("RData/Richards_Heat_St_K_norm.rds"))
  
} else {
  M2.Heat <- readRDS(paste0("RData/Richards_Heat_St_K_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_St_K_norm_LOOIC.rds")){
  M2.Heat.loo.out <- compute.looic(loglik = M2.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M2.Heat.loo.out, "RData/Richards_Heat_St_K_norm_LOOIC.rds")
} else {
  M2.Heat.loo.out <- readRDS("RData/Richards_Heat_St_K_norm_LOOIC.rds")
}


jags.params <- c("sigma.y", "S", "K1", "K2", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Heat_S_K1_K2_norm.rds"))){
  M3.Heat <- jags(jags.data.Heat,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_S_K1_K2_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M3.Heat, paste0("RData/Richards_Heat_S_K1_K2_norm.rds"))
  
} else {
  M3.Heat <- readRDS(paste0("RData/Richards_Heat_S_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_S_K1_K2_norm_LOOIC.rds")){
  M3.Heat.loo.out <- compute.looic(loglik = M3.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M3.Heat.loo.out, "RData/Richards_Heat_S_K1_K2_norm_LOOIC.rds")
} else {
  M3.Heat.loo.out <- readRDS("RData/Richards_Heat_S_K1_K2_norm_LOOIC.rds")
}


if (!file.exists(paste0("RData/Richards_Heat_St_K1_K2_norm.rds"))){
  M4.Heat <- jags(jags.data.Heat,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_St_K1_K2_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M4.Heat, paste0("RData/Richards_Heat_St_K1_K2_norm.rds"))
  
} else {
  M4.Heat <- readRDS(paste0("RData/Richards_Heat_St_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_St_K1_K2_norm_LOOIC.rds")){
  M4.Heat.loo.out <- compute.looic(loglik = M4.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M4.Heat.loo.out, "RData/Richards_Heat_St_K1_K2_norm_LOOIC.rds")
} else {
  M4.Heat.loo.out <- readRDS("RData/Richards_Heat_St_K1_K2_norm_LOOIC.rds")
}

jags.params <- c("sigma.y", "S1", "S2", "K", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Heat_S1_S2_K_norm.rds"))){
  M5.Heat <- jags(jags.data.Heat,
                  inits = NULL,
                  parameters.to.save= jags.params,
                  model.file = 'models/model_Richards_S1_S2_K_norm.txt',
                  n.chains = MCMC.params$n.chains,
                  n.burnin = MCMC.params$n.burnin,
                  n.thin = MCMC.params$n.thin,
                  n.iter = MCMC.params$n.samples,
                  DIC = T, parallel=T)
  
  saveRDS(M5.Heat, paste0("RData/Richards_Heat_S1_S2_K_norm.rds"))
  
} else {
  M5.Heat <- readRDS(paste0("RData/Richards_Heat_S1_S2_K_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_S1_S2_K_norm_LOOIC.rds")){
  M5.Heat.loo.out <- compute.looic(loglik = M5.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M5.Heat.loo.out, "RData/Richards_Heat_S1_S2_K_norm_LOOIC.rds")
} else {
  M5.Heat.loo.out <- readRDS("RData/Richards_Heat_S1_S2_K_norm_LOOIC.rds")
}


jags.params <- c("sigma.y", "S1", "S2", "K1", "K2", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Heat_S1_S2_K1_K2_norm.rds"))){
  M6.Heat <- jags(jags.data.Heat,
                  inits = NULL,
                  parameters.to.save= jags.params,
                  model.file = 'models/model_Richards_S1_S2_K1_K2_norm.txt',
                  n.chains = MCMC.params$n.chains,
                  n.burnin = MCMC.params$n.burnin,
                  n.thin = MCMC.params$n.thin,
                  n.iter = MCMC.params$n.samples,
                  DIC = T, parallel=T)
  
  saveRDS(M6.Heat, paste0("RData/Richards_Heat_S1_S2_K1_K2_norm.rds"))
  
} else {
  M6.Heat <- readRDS(paste0("RData/Richards_Heat_S1_S2_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Heat_S1_S2_K1_K2_norm_LOOIC.rds")){
  M6.Heat.loo.out <- compute.looic(loglik = M6.Heat$sims.list$loglik,
                                   data.vector = data.heat.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M6.Heat.loo.out, "RData/Richards_Heat_S1_S2_K1_K2_norm_LOOIC.rds")
} else {
  M6.Heat.loo.out <- readRDS("RData/Richards_Heat_S1_S2_K1_K2_norm_LOOIC.rds")
}

LOOIC.Heat <- data.frame(model = c("M1", "M2", "M3", "M4", "M5", "M6"),
                         LOOIC = c(M1.Heat.loo.out$estimates["looic", "Estimate"],
                                   M2.Heat.loo.out$estimates["looic", "Estimate"],
                                   M3.Heat.loo.out$estimates["looic", "Estimate"],
                                   M4.Heat.loo.out$estimates["looic", "Estimate"],
                                   M5.Heat.loo.out$estimates["looic", "Estimate"],
                                   M6.Heat.loo.out$estimates["looic", "Estimate"]),
                         SE = c(M1.Heat.loo.out$estimates["looic", "SE"],
                                   M2.Heat.loo.out$estimates["looic", "SE"],
                                   M3.Heat.loo.out$estimates["looic", "SE"],
                                   M4.Heat.loo.out$estimates["looic", "SE"],
                                   M5.Heat.loo.out$estimates["looic", "SE"],
                                   M6.Heat.loo.out$estimates["looic", "SE"])) %>%
  arrange(by = LOOIC)

# A quick look at DICs
DIC.Heat <- data.frame(Model = c("M1", "M2", "M3", "M4", "M5", "M6"),
                       DIC = c(M1.Heat$DIC, M2.Heat$DIC, 
                               M3.Heat$DIC, M4.Heat$DIC, 
                               M5.Heat$DIC, M6.Heat$DIC)) %>%
  arrange(by = DIC)
```

Model 4 (St_K1_K2) seems to be the best according to LOOIC and DIC values. Pareto k statistics look okay also...

```{r}
pareto_k_table(M1.Heat.loo.out)
    
```
We'll use Model 4 for computing the total deaths due to the heat related reasons.

```{r}
X_Heat_St_K1_K2.df <- compute.summary.stats_St_K1_K2(M4.Heat$samples, 
                                                     seasons, 
                                                     max.days$total.days, 
                                                     P)

ggplot() + 
  geom_path(data = X_Heat_St_K1_K2.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Heat_St_K1_K2.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
  geom_point(data = data.1,
             aes(x = DOS, y = Heat)) + 
  facet_wrap(.~ as.factor(Season))


```

Now we add all values of Xs for each year

```{r}
X_Heat_St_K1_K2.df %>% 
  group_by(Season) %>%
  summarise(total.low = sum(ceiling(Low), na.rm = T),
            total.med = sum(ceiling(Med), na.rm = T),
            total.high = sum(ceiling(High), na.rm = T)) -> total.deaths.heat
```

# Cliff fall
Same can be done for cliff fall deaths:

```{r}
# first just run one at a time
jags.data.Cliff <- list(y = (obs.y.1[,,2]),
                       t = obs.t,
                       P = P,
                       n.vec = n.vec,
                       n.seasons = n.seasons,
                       max.vec = max.mat[,1])

# Convert the data into a vector also and match with the log-likelihood vector
# for computing looic.
data.cliff.vector <- as.vector(jags.data.Cliff$y) %>% 
  rep(each = MCMC.params$n.chains * n.per.chain)

jags.params <- c("sigma.y", "S", "K", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Cliff_S_K_norm.rds"))){
  M1.Cliff <- jags(jags.data.Cliff,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = 'models/model_Richards_S_K_norm.txt',
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)
  
  saveRDS(M1.Heat, paste0("RData/Richards_Cliff_S_K_norm.rds"))
  
} else {
  M1.Cliff <- readRDS(paste0("RData/Richards_Cliff_S_K_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_S_K_norm_LOOIC.rds")){
  M1.Cliff.loo.out <- compute.looic(loglik = M1.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M1.Cliff.loo.out, "RData/Richards_Cliff_S_K_norm_LOOIC.rds")
} else {
  M1.Cliff.loo.out <- readRDS("RData/Richards_Cliff_S_K_norm_LOOIC.rds")
}

if (!file.exists(paste0("RData/Richards_Cliff_St_K_norm.rds"))){ 
  M2.Cliff <- jags(jags.data.Cliff,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_St_K_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M2.Cliff, paste0("RData/Richards_Cliff_St_K_norm.rds"))
  
} else {
  M2.Cliff <- readRDS(paste0("RData/Richards_Cliff_St_K_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_St_K_norm_LOOIC.rds")){
  M2.Cliff.loo.out <- compute.looic(loglik = M2.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M2.Cliff.loo.out, "RData/Richards_Cliff_St_K_norm_LOOIC.rds")
} else {
  M2.Cliff.loo.out <- readRDS("RData/Richards_Cliff_St_K_norm_LOOIC.rds")
}


jags.params <- c("sigma.y", "S", "K1", "K2", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))){
  M3.Cliff <- jags(jags.data.Cliff,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_S_K1_K2_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M3.Cliff, paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))
  
} else {
  M3.Cliff <- readRDS(paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_S_K1_K2_norm_LOOIC.rds")){
  M3.Cliff.loo.out <- compute.looic(loglik = M3.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M3.Cliff.loo.out, "RData/Richards_Cliff_S_K1_K2_norm_LOOIC.rds")
} else {
  M3.Cliff.loo.out <- readRDS("RData/Richards_Cliff_S_K1_K2_norm_LOOIC.rds")
}


if (!file.exists(paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))){
  M4.Cliff <- jags(jags.data.Cliff,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_St_K1_K2_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(M4.Cliff, paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))
  
} else {
  M4.Cliff <- readRDS(paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_St_K1_K2_norm_LOOIC.rds")){
  M4.Cliff.loo.out <- compute.looic(loglik = M4.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M4.Cliff.loo.out, "RData/Richards_Cliff_St_K1_K2_norm_LOOIC.rds")
} else {
  M4.Cliff.loo.out <- readRDS("RData/Richards_Cliff_St_K1_K2_norm_LOOIC.rds")
}

jags.params <- c("sigma.y", "S1", "S2", "K", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Cliff_S1_S2_K_norm.rds"))){
  M5.Cliff <- jags(jags.data.Cliff,
                  inits = NULL,
                  parameters.to.save= jags.params,
                  model.file = 'models/model_Richards_S1_S2_K_norm.txt',
                  n.chains = MCMC.params$n.chains,
                  n.burnin = MCMC.params$n.burnin,
                  n.thin = MCMC.params$n.thin,
                  n.iter = MCMC.params$n.samples,
                  DIC = T, parallel=T)
  
  saveRDS(M5.Cliff, paste0("RData/Richards_Cliff_S1_S2_K_norm.rds"))
  
} else {
  M5.Cliff <- readRDS(paste0("RData/Richards_Cliff_S1_S2_K_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_S1_S2_K_norm_LOOIC.rds")){
  M5.Cliff.loo.out <- compute.looic(loglik = M5.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M5.Cliff.loo.out, "RData/Richards_Cliff_S1_S2_K_norm_LOOIC.rds")
} else {
  M5.Cliff.loo.out <- readRDS("RData/Richards_Cliff_S1_S2_K_norm_LOOIC.rds")
}


jags.params <- c("sigma.y", "S1", "S2", "K1", "K2", "max",
                 "y", "X", "sigma.max", "deviance", "loglik")

if (!file.exists(paste0("RData/Richards_Cliff_S1_S2_K1_K2_norm.rds"))){
  M6.Cliff <- jags(jags.data.Cliff,
                  inits = NULL,
                  parameters.to.save= jags.params,
                  model.file = 'models/model_Richards_S1_S2_K1_K2_norm.txt',
                  n.chains = MCMC.params$n.chains,
                  n.burnin = MCMC.params$n.burnin,
                  n.thin = MCMC.params$n.thin,
                  n.iter = MCMC.params$n.samples,
                  DIC = T, parallel=T)
  
  saveRDS(M6.Cliff, paste0("RData/Richards_Cliff_S1_S2_K1_K2_norm.rds"))
  
} else {
  M6.Cliff <- readRDS(paste0("RData/Richards_Cliff_S1_S2_K1_K2_norm.rds"))
}

if (!file.exists("RData/Richards_Cliff_S1_S2_K1_K2_norm_LOOIC.rds")){
  M6.Cliff.loo.out <- compute.looic(loglik = M6.Cliff$sims.list$loglik,
                                   data.vector = data.cliff.vector,
                                   MCMC.params = MCMC.params)
  saveRDS(M6.Cliff.loo.out, "RData/Richards_Cliff_S1_S2_K1_K2_norm_LOOIC.rds")
} else {
  M6.Cliff.loo.out <- readRDS("RData/Richards_Cliff_S1_S2_K1_K2_norm_LOOIC.rds")
}

LOOIC.Cliff <- data.frame(model = c("M1", "M2", "M3", "M4", "M5", "M6"),
                         LOOIC = c(M1.Cliff.loo.out$estimates["looic", "Estimate"],
                                   M2.Cliff.loo.out$estimates["looic", "Estimate"],
                                   M3.Cliff.loo.out$estimates["looic", "Estimate"],
                                   M4.Cliff.loo.out$estimates["looic", "Estimate"],
                                   M5.Cliff.loo.out$estimates["looic", "Estimate"],
                                   M6.Cliff.loo.out$estimates["looic", "Estimate"]),
                         SE = c(M1.Cliff.loo.out$estimates["looic", "SE"],
                                   M2.Cliff.loo.out$estimates["looic", "SE"],
                                   M3.Cliff.loo.out$estimates["looic", "SE"],
                                   M4.Cliff.loo.out$estimates["looic", "SE"],
                                   M5.Cliff.loo.out$estimates["looic", "SE"],
                                   M6.Cliff.loo.out$estimates["looic", "SE"])) %>%
  arrange(by = LOOIC)

# A quick look at DICs
DIC.Cliff <- data.frame(Model = c("M1", "M2", "M3", "M4", "M5", "M6"),
                       DIC = c(M1.Cliff$DIC, M2.Cliff$DIC, 
                               M3.Cliff$DIC, M4.Cliff$DIC, 
                               M5.Cliff$DIC, M6.Cliff$DIC)) %>%
  arrange(by = DIC)
```




```{r}
X_Cliff_St_K_df <- compute.summary.stats_St_K(samples = jm.1.Cliff$samples, 
                                              seasons = seasons, 
                                              max.days = max.days$total.days, 
                                              P = P)

ggplot() + 
  geom_path(data = X_Cliff_St_K_df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Cliff_St_K_df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
      geom_point(data = data.1,
             aes(x = DOS, y = Heat)) + 

  facet_wrap(.~ as.factor(Season))
```



```{r}
X_Cliff_S_K.df <- compute.summary.stats_S_K(samples = jm.2.Cliff$samples, 
                                           seasons = seasons, 
                                           max.days = max.days$total.days, 
                                           P = P)

ggplot() + 
  geom_path(data = X_Cliff_S_K.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Cliff_S_K.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
     geom_point(data = data.1,
             aes(x = DOS, y = Heat)) + 
 facet_wrap(.~ as.factor(Season))
```


I created a modified version of the function by Girondot et al. In this model, I created two K parameters; one for increasing part and the other for decreasing part. Let's see how this model fits to the data/

# Heat with the new model
```{r}


```



```{r}
X_Heat_St_K1_K2.df <- compute.summary.stats_St_K1_K2(samples = M4.Heat$samples, 
                                                     seasons = seasons, 
                                                     max.days = max.days$total.days, 
                                                     P = P)

X_Heat_S_K1_K2.df <- compute.summary.stats_S_K1_K2(samples = M3.Heat$samples, 
                                           seasons = seasons, 
                                           max.days = max.days$total.days, 
                                           P = P)

```



```{r}
ggplot() + 
  geom_path(data = X_Heat_St_K1_K2.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Heat_St_K1_K2.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
     geom_point(data = data.1,
             aes(x = DOS, y = Heat)) + 
 facet_wrap(.~ as.factor(Season))
```

```{r}
ggplot() + 
  geom_path(data = X_Heat_S_K1_K2.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Heat_S_K1_K2.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
     geom_point(data = data.1,
             aes(x = DOS, y = Heat)) + 
 facet_wrap(.~ as.factor(Season))
```

```{r}
c(M2.Heat$DIC, M1.Heat$DIC, M4.Heat$DIC, M3.Heat$DIC)
```


# Cliff fall with the new model
```{r}

if (!file.exists(paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))){
  jm.3.Cliff <- jags(jags.data.Cliff,
                    inits = NULL,
                    parameters.to.save= jags.params,
                    model.file = 'models/model_Richards_St_K1_K2_norm.txt',
                    n.chains = MCMC.params$n.chains,
                    n.burnin = MCMC.params$n.burnin,
                    n.thin = MCMC.params$n.thin,
                    n.iter = MCMC.params$n.samples,
                    DIC = T, parallel=T)
  
  saveRDS(jm.3.Cliff, paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))
  
} else {
  jm.3.Cliff <- readRDS(paste0("RData/Richards_Cliff_St_K1_K2_norm.rds"))
}

if (!file.exists(paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))){
  jm.4.Cliff <- jags(jags.data.Cliff,
                     inits = NULL,
                     parameters.to.save= jags.params,
                     model.file = 'models/model_Richards_S_K1_K2_norm.txt',
                     n.chains = MCMC.params$n.chains,
                     n.burnin = MCMC.params$n.burnin,
                     n.thin = MCMC.params$n.thin,
                     n.iter = MCMC.params$n.samples,
                     DIC = T, parallel=T)
  
  saveRDS(jm.4.Cliff, paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))
  
} else {
  jm.4.Cliff <- readRDS(paste0("RData/Richards_Cliff_S_K1_K2_norm.rds"))
}

```



```{r}
X_Cliff_St_K1_K2.df <- compute.summary.stats_St_K1_K2(samples = jm.3.Cliff$samples, 
                                                      seasons = seasons, 
                                                      max.days = max.days$total.days, 
                                                      P = P)

X_Cliff_S_K1_K2.df <- compute.summary.stats_S_K1_K2(samples = jm.4.Cliff$samples, 
                                                    seasons = seasons, 
                                                    max.days = max.days$total.days, 
                                                    P = P)

```



```{r}
ggplot() + 
  geom_path(data = X_Cliff_St_K1_K2.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Cliff_St_K1_K2.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
     geom_point(data = data.1,
             aes(x = DOS, y = Cliff)) + 
 facet_wrap(.~ as.factor(Season))
```



```{r}
ggplot() + 
  geom_path(data = X_Cliff_S_K1_K2.df,
            aes(x = DOS, y = Med)) +
  geom_ribbon(data = X_Cliff_S_K1_K2.df,
              aes(x = DOS, ymin = Low, ymax = High),
              alpha = 0.4) + 
     geom_point(data = data.1,
             aes(x = DOS, y = Cliff)) + 
 facet_wrap(.~ as.factor(Season))
```


```{r}
c(jm.1.Cliff$DIC, jm.2.Cliff$DIC, jm.3.Cliff$DIC, jm.4.Cliff$DIC)
```


Start here next... 2020-06-16

Things to do:
1. Add likelihood lines to the models and run all models again
2. Using the likelihood values, compute looic
3. Do model comparison using DIC or looic
4. Consider using mvnormal for heat-related and cliff-fall deaths together



